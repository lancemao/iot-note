# 设备注册

设备管理的第一步是设备注册。只有注册的设备才能使用 IoT 平台的功能。这和用户注册非常相似，一般的系统都需要用户登录，用户在登录前必须先注册帐号。那对于 IoT 设备我们需要注册什么信息呢？

## 注册要素

一个用户的帐号至少包含两个字段，一个是唯一标识符，即 Identifier，简称 ID。唯一标识符也可以为电话号码、邮箱、用户名、工号、系统生成的唯一字符串或者整数等。另外一个是校验码，可以是密码、短信验证码、OTP（One Time Password）、指纹、人脸特征等信息。当用户登录时，需要提供这两个信息。

类似的，设备也需要提供唯一标识符和校验码。考虑到设备无法输入动态的验证码，所以只能使用某种密码，我们统称为`密钥`。常见的密钥有 `Shared Secret` 和`证书`两类，前者的主要问题是服务端和设备保存着同一份密钥，而使用非对称加密的证书方式可以实现服务端和设备持有不同的密钥，所以这里我们以 X.509 证书方式来讨论如何实现设备注册。

非对称加密的核心是生成两个密钥：`公钥`和`私钥`。用公钥加密的信息可以用私钥解密，反之亦然，用私钥加密的信息可以用公钥解密。

::: tip
虽然私钥可以直接对数据进行加密，但这样做没有任何实际意义，因为公钥是公开的，任何人都可以对数据进行解密。所以私钥的使用方法一般是用来做`签名`，以防止数据被篡改。
:::

基于这个思想，我们只需要将一个密钥放 IoT 平台，另外一个放到设备端即可。那放哪一个到设备端，哪一个到 IoT 平台呢？考虑到这里的密钥扮演着密码的角色，所以我们应该把私钥放到设备端，把公钥放到 IoT 平台。私钥放到设备上会不会有安全问题？会！所以对于安全要求高的场景，我们需要将私钥放到设备上某种加密芯片里面，防止黑客获取私钥。

通过上面讨论，我们得出设备注册的两个要素信息：

1. 设备标识符（设备 ID）
2. 设备公钥（或者 X.509 证书）

::: tip
设备私钥放设备端
:::

::: warning
某些 IoT 平台，还要求设备提供其他信息，如 Azure IoT 要求提供应用 ID、设备型号 ID 等信息
:::

## 公钥和证书

用一句话描述证书：**证书用来绑定公钥和主体**。

也就是说，公钥是证书的一部分，证书里面除了公钥数据，至少还包含两个数据，一个是**名字**，或者叫**主体**，最常见的是网站的 TLS 证书，它绑定了网站的域名和网站的公钥。另外一个是签名，这个签名可以是自签名，但更为常见的是，由另外机构的私钥来做签名，这里的**另外机构**，就被叫做 Certificate Authority（简称 CA），其实质是另外一组公私钥。签名告诉证书依赖方：证书里面的公钥确实属于证书里面的主体，请放心使用。

根据以上讨论，我们只需要把设备的公钥注册到 IoT 平台不就可以了吗？对于简单的场景，是可以的。上传证书和只上传公钥的区别在于，证书是被 CA 签名的，如果我们想构建一个权威的 IoT 平台，我们平台本身就可以扮演 CA 的角色，即所有设备需要先在我们的 IoT 平台做认证，只有认证通过的设备，IoT 平台才颁发证书，当设备入网时，平台对其证书进行**验签**，保证设备的合法性，从而保证了系统的安全性，防止黑客篡改设备信息。

## 注册方式

如何将上面的两个要素信息提供给 IoT 平台？通常有三种方式：

* 设备自助注册。当设备第一次启动时，携带烧录的信息到 IoT 平台自行注册。
::: tip
在用户认证场景，有时我们不希望用户自助注册，如企业员工只能通过管理员创建帐号。同理，我们有时不希望设备能自助注册。
:::
* IoT 平台批量导入。租户管理员在 IoT 平台的控制台上，通过 Excel 批量导入设备注册信息。
* IoT 平台创建单台设备。租户管理员在 IoT 平台的控制台上，为每台设备手动注册。

## 生成证书

无论使用哪种注册方式，都要求开发者提前在 IoT 平台的控制台上生成一个**租户根证书**。而设备的公钥可以由租户自行生成后上传，也可以由 IoT 平台生成。当设备提供公私钥时，租户根证书可以对其公钥签名得到设备证书。对于私钥，如果是设备厂商生成，可以不用上传到 IoT 平台，如果是平台生成，则需要厂商下载私钥以烧录至设备。

::: tip
从租户数据隔离和平台自身安全性考虑，建议平台自身有一个自签名的证书，作为整个系统的 root CA，每个租户有自己的根证书，这些证书由平台 root 证书签发。
:::