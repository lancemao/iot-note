# 设备注册

设备管理的第一步是设备注册。只有注册的设备才能使用 IoT 平台的功能。这和用户注册非常相似，一般的系统都需要用户登录，用户在登录前必须先注册帐号。那对于 IoT 设备我们需要注册什么信息呢？

## 注册要素

一个用户的帐号至少包含两个字段，一个是唯一标识符，即 Identifier，简称 ID，另外一个是校验码，可以是密码、证书、短信验证码、OTP（One Time Password）、指纹、人脸特征等信息。当用户登录时，需要提供这两个信息。

::: tip
帐号的唯一标识符也可以为电话号码、邮箱、用户名、工号等
:::

类似的，设备也需要提供唯一标识符和校验码。考虑到设备无法输入动态的验证码，所以只能使用某种密码，我们统称为`密钥`。常见的密钥有 `Shared Secret` 和`证书`两类，前者的主要问题是服务端和设备保存着同一份密钥，而使用非对称加密的证书方式可以实现服务端和设备持有不同的密钥，所以这里我们以 X.509 证书方式来讨论如何实现设备注册。

非对称加密的核心是生成两个密钥：`公钥`和`私钥`。用公钥加密的信息可以用私钥解密，反之亦然，用私钥加密的信息可以用公钥解密。基于这个思想，我们只需要将一个密钥放 IoT 平台，另外一个放到设备端即可。那放哪一个到设备端，哪一个到 IoT 平台呢？考虑到这里的密钥扮演着密码的角色，所以我们应该把私钥放到设备端，把公钥放到 IoT 平台。私钥放到设备上会不会有安全问题？会！所以对于安全要求高的场景，我们需要将私钥放到设备上某种加密芯片里面，防止黑客通过 Reverse Engineering 获取私钥。

通过上面讨论，我们得出设备注册的两个要素信息：

1. 设备标识符（设备 ID）
2. 设备私钥

::: warning
某些 IoT 平台，还要求设备提供其他信息，如 Azure IoT 要求提供应用 ID、设备型号 ID 等信息
:::

## 生成证书

无论使用下面哪种注册方式，都要求开发者提前在 IoT 平台的控制台上生成一个根证书。根证书可以导出具体的设备证书，以供硬件厂商在设备出厂时，将设备证书私钥烧录至设备上。

## 注册方式

如何将上面的两个信息提供给 IoT 平台？通常有三种方式：

* 设备自动注册。当设备第一次启动时，携带烧录的信息到 IoT 平台自行注册。
* IoT 平台批量导入。租户管理员在 IoT 平台的控制台上，通过 Excel 批量导入设备注册信息。
* IoT 平台创建单台设备。租户管理员在 IoT 平台的控制台上，为每台设备手动注册。
