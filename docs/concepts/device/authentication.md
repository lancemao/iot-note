# 设备认证

对于接入了 IoT 平台的设备，在其发送遥测数据（Telemetry）或者接受平台下发的指令（Command and Control）之前，必须对其进行认证，这个过程非常类似用户登录。

在 [设备注册](./register.md) 一节中，我们已经在 IoT 平台注册了设备的 ID 和密钥，当设备启动时，可携带这两个信息到平台认证。

## 认证方式

最简单的认证实现方式就是直接在平台数据库里面校验这两个信息是否匹配，这也是常见的用户登录的校验方法。这种简单的校验方式会在网络上传输明文密钥。

::: tip
对于发送用户名密码登录的方式，我们一般会在客户端对密码加密后再发送给服务端。如果我们要对设备密钥加密，我们需要引入另外一组公私钥。
:::

我们意识到，和用户的密码不同，设备的密钥本身就可以用来加解密，所以我们可以使用一种典型的 code challenge 认证方式。其思路是在设备端随机生成一段字符串，对其进行签名，然后把原始字符串加上签名一起发给 IoT 平台，平台对数据进行验签，若合法，则表示认证通过。

这里用到了数字签名里的 **签名** 和 **验签** 思想，各种语言都有现成的库可以直接使用，一些语言如 Java 还提供内置实现，无需引入第三方库。其原理并不复杂，下面稍微展开讨论一下。

假设双方分别持有公钥和私钥，在我们的例子中，设备端持有私钥，IoT 平台持有公钥。

`签名`：持有私钥的一方首先使用摘要算法如 SHA-256 计算出数据的摘要，然后用私钥对摘要进行加密，加密后的数据叫做签名（signature）。接下来，私钥持有方将原始数据和签名一起发出去。

::: tip
为什么要先计算摘要而不是直接对数据加密？因为数据本身的长度是不确定的，可以为任意长度，但摘要的长度是确定的，SHA-1 为 20 字节，SHA-256 为 32 字节。这样不仅减少了加密后的数据量，还减少了加密时间。
:::

`验签`：持有公钥的一方收到数据和签名后，采用同样的摘要算法计算出数据的摘要，再使用公钥对签名进行解密，将第一步和第二步的结果对比，如果匹配则表示通过验签，也就是说数据确实是私钥持有者发出的。

## 连接状态

设备对认证状态的处理取决于设备的连接方式，IoT 设备有两种连接方式：

1. 长连接

对于需要云端控制设备的场景，IoT 平台需要和设备建立长连接，这样才能保证数据的实时性。这种模式下，应用层通过 MQTT 或者 AMQP 等协议传输数据。在这种连接方式下，最简单的认证状态处理就是设备和 IoT 云建立的连接本身，也就是说只有认证通过的设备才能和 IoT 云建立连接。

2. 无状态连接

这种方式和典型的 Web 应用一致，应用层通过 HTTP、CoAP 等协议传输数据。当设备通过认证后，IoT 平台需要返回某种凭证，常见的有 SessionID（会话 ID）和 JWT（包含认证主体信息的令牌）。

::: tip
使用凭证的方式会增加数据传输量，因为后续每次发送数据都要携带凭证。
:::
