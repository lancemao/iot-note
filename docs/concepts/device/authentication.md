# 设备认证

对于接入了 IoT 平台的设备，在其发送遥测数据（Telemetry）或者接受平台下发的指令（Command and Control）之前，必须对其进行认证，这个过程非常类似用户登录。

在 [设备注册](./register.md) 一节中，我们已经在 IoT 平台注册了设备的 ID 和密钥，当设备启动时，可携带这两个信息到平台认证。

## 认证方式

最简单的认证实现方式就是直接在平台数据库里面校验这两个信息是否匹配，这也是常见的用户登录的校验方法。这种简单的校验方式会在网络上传输明文密钥。

::: tip
对于发送用户名密码登录的方式，我们一般会在客户端对密码加密后再发送给服务端。如果我们要对设备密钥加密，我们需要引入另外一组公私钥。
:::

我们意识到，和用户的密码不同，设备的密钥本身就可以用来加解密，所以我们可以使用一种典型的 code challenge 的认证方式。其思路是在 IoT 平台生成一个字符串，叫做 code challenge，发送给设备，设备用其密钥加密得到另外一个字符串，发送给 IoT 平台，平台用公钥解密后和 code challenge 对比，若匹配则表示认证通过。

## 连接状态

设备对认证状态的处理取决于设备的连接方式，IoT 设备有两种连接方式：

1. 长连接

对于需要云端控制设备的场景，IoT 平台需要和设备建立长连接，这样才能保证数据的实时性。这种模式下，应用层通过 MQTT 或者 AMQP 等协议传输数据。在这种连接方式下，最简单的认证状态处理就是设备和 IoT 云建立的连接本身，也就是说只有认证通过的设备才能和 IoT 云建立连接。

2. 无状态连接

这种方式和典型的 Web 应用一致，应用层通过 HTTP、CoAP 等协议传输数据。当设备通过认证后，IoT 平台需要返回某种凭证，常见的有 SessionID（会话 ID）和 JWT（包含认证主体信息的令牌）。

::: tip
使用凭证的方式会增加数据传输量
:::
